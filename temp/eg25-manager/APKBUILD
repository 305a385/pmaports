# Forked from Alpine to upgrade to current git master, which has
# Ofono compatibility fixes needed for Plasma Mobile

pkgname=eg25-manager
pkgver=0.3.0_git20210522
_commit="73e16f76994b1d3c587796a35766cc668e30c0cd"
pkgrel=0
pkgdesc="Daemon for managing the Quectel EG25 modem"
url="https://gitlab.com/mobian1/devices/eg25-manager"
arch="all !s390x !mips64"  # no modemmanager
license="GPL-3.0-or-later"
makedepends="
	glib-dev
	libgpiod-dev
	libgudev-dev
	libusb-dev
	meson
	modemmanager-dev
	curl-dev
	"
source="
	https://gitlab.com/mobian1/devices/eg25-manager/-/archive/$_commit/eg25-manager-$_commit.tar.gz
	eg25-manager.confd
	eg25-manager.initd
	0001-mm-iface-clean-out-modem_iface-if-mm-disappears.patch
	"
options="!check"  # no tests
subpackages="$pkgname-openrc"
builddir="$srcdir/eg25-manager-$_commit"

build() {
	abuild-meson . output

	# For some reason, the header files don't get generated first by the meson
	# command below.
	for i in gdbo-manager.h gdbo-modem.h; do
		ninja -C output src/libgdbofono/$i
	done

	meson compile ${JOBS:+-j ${JOBS}} -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
	install -Dm755 "$srcdir"/eg25-manager.initd "$pkgdir"/etc/init.d/eg25-manager
	install -Dm644 "$srcdir"/eg25-manager.confd "$pkgdir"/etc/conf.d/eg25-manager
}

sha512sums="
2b0d706c893744529e035e8dc70b381362e39ddd2be705e346f0fd88e4907093e59b30800ad5ecb90638338b25bb51308349fb26de2c786197aeed8c1fa9c68a  eg25-manager-73e16f76994b1d3c587796a35766cc668e30c0cd.tar.gz
55936830afad2968a214fb39cfe1a9db50421dc2ff4f67d04f08f6bd2b094c3ab46799cfc7743bbc5032682d98d1216203adf5264353a05134bea58524ac070b  eg25-manager.confd
0dd866ce18bac37c3832a463205402f5b34a520e1a57cc37658fb37e21a173fbba2cfab223111c68af768be1d3feeb23e41dbaf6d8dc14a2b2c0c088cf3df041  eg25-manager.initd
029dce7e7d6e79faab2a63acde2fe76109e5e269bf38d72617d00ffbb89001f75b604e79290d449db7a6f960f9872eb41c2d0ab4a6d82d7563b66e954cd4ffa8  0001-mm-iface-clean-out-modem_iface-if-mm-disappears.patch
"
